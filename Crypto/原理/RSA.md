# RSA

### RSA简介

倘若在加解密信息的过程中，能让加密密钥（公钥）与解密密钥（私钥）不同，即

```
1. 甲要传密信给乙，乙先根据某种算法得出本次与甲通信的公钥与私钥；
2. 乙将公钥传给甲（公钥可以让任何人知道，即使泄露也没有任何关系）；
3. 甲使用乙传给的公钥加密要发送的信息原文m，发送给乙密文c；
4. 乙使用自己的私钥解密密文c，得到信息原文m .
```

### 数学概念

需要了解的几个数学概念

1.质数与互质数
2.欧拉函数
3.欧拉定理
4.模反元素
5.同余

### 质数与互质数

一个大于1的自然数，除了1和它本身外，不能被其他自然数整除（除0以外）的数称之为质数（素数）；否则称为合数。

公约数只有1的两个数，叫做互质数。

1.任意两个质数一定构成互质数（如3与11、53与61）；
2.大数是质数的两个数一定是互质数（如97与88）；

在RSA算法中，我们通常使用以上第1条与第2条，即选取两个本身都是质数的数作为互质数

### 欧拉函数

任意给定正整数n，计算在小于等于n的正整数之中，有多少个与n构成互质关系？
计算这个值的方法就叫做欧拉函数，以φ(n)表示.

例如，在1到8之中，与8形成互质关系的是1、3、5、7，所以φ(n)=4

在RSA算法中，我们需要明白欧拉函数对以下定理成立

1.如果n可以分解成两个互质的整数之积，即n=p×q，则有：φ(n)=φ(pq)=φ(p)φ(q);
2.根据“大数是质数的两个数一定是互质数”可以知道：
一个数如果是质数，则小于它的所有正整数与它都是互质数；
所以如果一个数p是质数，则有：φ(p)=p-1

由上易得，若我们知道一个数n可以分解为两个质数p和q的乘积，则有

φ(n)=(p-1)(q-1)


### 欧拉定理

如果两个正整数a和n互质，则n的欧拉函数φ(n)可以让下面的等式成立：
aφ(n)≡1(modn)

### 模运算与模反元素

模运算：让m去被n整除，只取所得的余数作为结果，就叫做模运算。
例如，10 mod 3 = 1 、26 mod 6 = 2 、28 mod 2 = 0


模反元素：如果两个正整数a和n互质，那么一定可以找到整数b，使得 ab-1 被n整除，或者说ab被n除的余数是1
ab≡1( mod n)
这时候，b就是a的模反元素

### 同余

“≡”是数论中表示同余的符号，定义如下：

给定一个正整数m，如果两个整数a和b满足a-b能被m整除，即(a-b) mod m=0，
那么就称整数a与b对模m同余，记作a≡b(modm)，同时可成立a mod m=b


### 需要记住的参数

p,q:大整数N的两个因子（factor）
N:大整数N，我们称之为模数（modulus）
e,d:互为模反数的两个指数（exponent）
c,m:密文和明文，这里一般指的是一个十进制的数
e：公钥
d：私钥


### RSA加密流程

- 首先选择两个互为质数p和q (q与p互素，公因数只有1)
- 求出n = p * q
- φ(n) = (p−1)*(q−1) 欧拉公式
- 公钥 e : 随机取，要求：e 和 φ(n) 互素（公因数只有 1）; 1< e < φ(n)；
- 私钥 d ：ed  ≡  1 （mod  φ(n) ）   （ed 除以 φ(n) 的 余数 为  1 ）
- e与d互为模反元素。

- 明文加密后的密文c = pow(m, e, n)

![image](./img/rsa1.png)

- 密文解密后的明文m = pow(c, d, n)

![image](./img/rsa2.png)


```
pow(x, y[, z])
函数是计算x的y次方，如果z在存在，则再对结果进行取模，其结果等效于pow(x,y) %z
```
### 依赖库的安装

```bash
apt-get install libgmp-dev
apt-get install libmpfr-dev
apt-get install libmpc-dev
apt-get install python3-pip
pip install gmpy2
```

### RSA题目

#### 简单

在一次RSA密钥对生成中，假设p=473398607161，q=4511491，e=17
求解出d作为flag提交


```py
import gmpy2
p=473398607161
q=4511491
e=17
d=gmpy2.invert(e,(q-1)*(p-1))  # 求逆元，de ≡ 1 mod n
print(d)
```

#### 进阶

## rsarsa

Math is cool! Use the RSA algorithm to decode the secret message, c, p, q, and e are parameters for the RSA algorithm.


p =  9648423029010515676590551740010426534945737639235739800643989352039852507298491399561035009163427050370107570733633350911691280297777160200625281665378483
q =  11874843837980297032092405848653656852760910154543380907650040190704283358909208578251063047732443992230647903887510065547947313543299303261986053486569407
e =  65537
c =  83208298995174604174773590298203639360540024871256126892889661345742403314929861939100492666605647316646576486526217457006376842280869728581726746401583705899941768214138742259689334840735633553053887641847651173776251820293087212885670180367406807406765923638973161375817392737747832762751690104423869019034

Use RSA to find the secret message

```py
# 已知 p q e c 求 m
import gmpy2
p =9648423029010515676590551740010426534945737639235739800643989352039852507298491399561035009163427050370107570733633350911691280297777160200625281665378483
q =11874843837980297032092405848653656852760910154543380907650040190704283358909208578251063047732443992230647903887510065547947313543299303261986053486569407
e =  65537
n = p*q
c =83208298995174604174773590298203639360540024871256126892889661345742403314929861939100492666605647316646576486526217457006376842280869728581726746401583705899941768214138742259689334840735633553053887641847651173776251820293087212885670180367406807406765923638973161375817392737747832762751690104423869019034


d = gmpy2.invert(e,(p-1)*(q-1)) # d是私钥
m = gmpy2.powmod(c,d,n)  # 幂取模，结果是 C = (M^e) mod n
# m = pow(c,d,n)
print(m)
```

## RSA1

p = 8637633767257008567099653486541091171320491509433615447539162437911244175885667806398411790524083553445158113502227745206205327690939504032994699902053229
q = 12640674973996472769176047937170883420927050821480010581593137135372473880595613737337630629752577346147039284030082593490776630572584959954205336880228469
dp = 6500795702216834621109042351193261530650043841056252930930949663358625016881832840728066026150264693076109354874099841380454881716097778307268116910582929
dq = 783472263673553449019532580386470672380574033551303889137911760438881683674556098098256795673512201963002175438762767516968043599582527539160811120550041
c = 24722305403887382073567316467649080662631552905960229399079107995602154418176056335800638887527614164073530437657085079676157350205351945222989351316076486573599576041978339872265925062764318536089007310270278526159678937431903862892400747915525118983959970607934142974736675784325993445942031372107342103852



### 参考文章

- [从RSA原理到CTF题解的学习之路](https://f5.pm/go-63001.html)
- [CTF ——crypto ——RSA原理及各种题型总结](https://blog.csdn.net/vhkjhwbs/article/details/101160822)
- [阮一峰-RSA原理](https://www.ruanyifeng.com/blog/2013/06/rsa_algorithm_part_one.html)

- [『CTF』史上最全 RSA 题目总结](https://mp.weixin.qq.com/s/DKyplEETXNzZ7Bt_Nm5-6g)

